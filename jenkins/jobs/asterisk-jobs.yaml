- job-template:
    name: 'periodic-{name}-{branch}'
    node: 'periodic'
    concurrent: true
    description: 'Periodic full testsuite run for {name} using {branch} branch'

    wrappers:
        - timeout:
            timeout: 300
            timeout-var: 'BUILD_TIMEOUT'
            fail: true
        - timestamps

    builders:
        - node-git-prep
        - gerrit-git-prep:
            branch: '{branch}'
            project: '{name}'
        - prep-testsuite
        - run-asterisk-unittests:
            build-asterisk-params:
            branch: '{branch}'
        - run-testsuite

    publishers:
        - publish-asterisk-unittests:
            project-name: '{name}'
        - publish-asterisk-testsuite

    logrotate:
        daysToKeep: 31
        artifactDaysToKeep: 31

- job-template:
    name: 'periodic-realtime-{name}-{branch}'
    node: 'periodic && realtime'
    concurrent: true
    description: 'Periodic testsuite run for {name} using {branch} branch against realtime'

    wrappers:
        - timeout:
            timeout: 300
            timeout-var: 'BUILD_TIMEOUT'
            fail: true
        - timestamps

    builders:
        - node-git-prep
        - gerrit-git-prep:
            branch: '{branch}'
            project: '{name}'
        - build-asterisk:
            build-asterisk-params: '-v -e DO_CRASH'
            branch: '{branch}'
        - prep-testsuite
        - prep-testsuite-realtime
        - prep-asterisk-realtime
        - run-testsuite:
            testsuite-params: '-t tests/channels/pjsip -G realtime-incompatible'

    publishers:
        - publish-asterisk-testsuite

    logrotate:
        daysToKeep: 31
        artifactDaysToKeep: 31

- job-template:
    name: 'periodic-documentation-{name}-{branch}'
    node: '(centos || debian) && doc'
    concurrent: true
    description: 'Periodic wiki documentation update for {name} using {branch} branch'

    wrappers:
        - timeout:
            timeout: 300
            timeout-var: 'BUILD_TIMEOUT'
            fail: true
        - timestamps

    builders:
        - node-git-prep
        - prep-wiki-documentation:
            branch: '{branch}'
        - update-wiki-documentation:
            branch: '{branch}'

    logrotate:
        daysToKeep: 31
        artifactDaysToKeep: 31

- job-template:
    name: 'periodic-ref_debug-{name}-{branch}'
    node: 'debug'
    concurrent: true
    description: 'Periodic full testsuite run for {name} using {branch} branch with REF_DEBUG enabled'

    wrappers:
        - timeout:
            timeout: 1440
            timeout-var: 'BUILD_TIMEOUT'
            fail: true
        - timestamps

    builders:
        - node-git-prep
        - gerrit-git-prep:
            branch: '{branch}'
            project: '{name}'
        - prep-testsuite
        - run-asterisk-unittests:
            build-asterisk-params: '-e REF_DEBUG -d res_odbc -d res_jabber -d res_pjsip'
            branch: '{branch}'
        - run-testsuite

    publishers:
        - publish-asterisk-unittests:
            project-name: '{name}'
        - publish-asterisk-testsuite

    logrotate:
        daysToKeep: 31
        artifactDaysToKeep: 31

- job-template:
    name: 'check-{name}-32'
    node: 'check && 32-bit'
    concurrent: true
    description: 'Basic build and unit test run for {name} on 32-bit'

    wrappers:
        - timeout:
            timeout: 60
            timeout-var: 'BUILD_TIMEOUT'
            fail: true
        - timestamps

    builders:
        - node-git-prep
        - gerrit-git-prep
        - run-asterisk-unittests:
            build-asterisk-params:
            branch: '{branch}'

    publishers:
        - publish-asterisk-unittests:
            project-name: '{name}'

    logrotate:
        daysToKeep: 7
        artifactDaysToKeep: 7

- job-template:
    name: 'check-{name}-64'
    node: 'check && 64-bit'
    concurrent: true
    description: 'Basic build and unit test run for {name} on 64-bit'

    wrappers:
        - timeout:
            timeout: 60
            timeout-var: 'BUILD_TIMEOUT'
            fail: true
        - timestamps

    builders:
        - node-git-prep
        - gerrit-git-prep
        - run-asterisk-unittests:
            build-asterisk-params:
            branch: '{branch}'

    publishers:
        - publish-asterisk-unittests:
            project-name: '{name}'

    logrotate:
        daysToKeep: 7
        artifactDaysToKeep: 7

- job-template:
    name: 'gate-{name}'
    node: 'gate'
    concurrent: true

    wrappers:
        - timeout:
            timeout: 60
            timeout-var: 'BUILD_TIMEOUT'
            fail: true
        - timestamps

    builders:
        - node-git-prep
        - gerrit-git-prep
        - run-asterisk-unittests:
            build-asterisk-params:
            branch: '{branch}'

    publishers:
        - publish-asterisk-unittests:
            project-name: '{name}'

    logrotate:
        daysToKeep: 7
        artifactDaysToKeep: 7

- job-template:
    name: 'gate-{name}-channel-drivers'
    node: 'gate'
    concurrent: true
    description: 'Gate for {name} using only channel testsuite tests'

    wrappers:
        - timeout:
            timeout: 180
            timeout-var: 'BUILD_TIMEOUT'
            fail: true
        - timestamps

    builders:
        - node-git-prep
        - gerrit-git-prep
        - build-asterisk:
            build-asterisk-params: '-v -e DO_CRASH'
            branch: '{branch}'
        - prep-testsuite
        - run-testsuite:
            testsuite-params: '-t tests/channels'

    publishers:
        - publish-asterisk-testsuite

    logrotate:
        daysToKeep: 7
        artifactDaysToKeep: 7

- job-template:
    name: 'gate-{name}-external-mwi'
    node: 'gate'
    concurrent: true
    description: 'Gate for {name} using external MWI tests'

    wrappers:
        - timeout:
            timeout: 60
            timeout-var: 'BUILD_TIMEOUT'
            fail: true
        - timestamps

    builders:
        - node-git-prep
        - gerrit-git-prep
        - build-asterisk:
            build-asterisk-params: '-v -d app_voicemail -e res_mwi_external -e res_mwi_external_ami -e res_stasis_mailbox -e DO_CRASH'
            branch: '{branch}'
        - prep-testsuite
        - run-testsuite:
            testsuite-params: '-g mwi_external -t tests/channels/pjsip/publish -t tests/channels/pjsip/subscriptions -t tests/realtime'

    publishers:
        - publish-asterisk-testsuite

    logrotate:
        daysToKeep: 7
        artifactDaysToKeep: 7

- job-template:
    name: 'gate-{name}-ari'
    node: 'gate'
    concurrent: true
    description: 'Gate for {name} using only ARI tests'

    wrappers:
        - timeout:
            timeout: 60
            timeout-var: 'BUILD_TIMEOUT'
            fail: true
        - timestamps

    builders:
        - node-git-prep
        - gerrit-git-prep
        - build-asterisk:
            build-asterisk-params: '-v -e app_voicemail -e app_directory -e test_voicemail_api -e FILE_STORAGE -e DO_CRASH'
            branch: '{branch}'
        - prep-testsuite
        - run-testsuite:
            testsuite-params: '-t tests/rest_api'

    publishers:
        - publish-asterisk-testsuite

    logrotate:
        daysToKeep: 7
        artifactDaysToKeep: 7

- job-group:
    name: asterisk-jobs
    jobs:
        - 'check-{name}-32'
        - 'check-{name}-64'
        - 'gate-{name}'
        - 'gate-{name}-channel-drivers'
        - 'gate-{name}-external-mwi'
        - 'gate-{name}-ari'
        - 'periodic-{name}-{branch}'
        - 'periodic-ref_debug-{name}-{branch}'
